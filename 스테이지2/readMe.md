스테이지 2 기술 명세서
=====================================================
* 최종 업데이트: 2025-11-15

## 변경된 기술 명세서 (v2.0) - 주요 변경 사항 요약

이 문서는 2025년 11월 15일 기준으로 스테이지 2에 적용된 주요 변경 사항들을 요약합니다.

### 1. 보스 (쇄빙선)
*   **유도 미사일 상시 활성화:** 이제 유도 미사일은 게임 시작부터 상시 발사됩니다.
*   **추가 기본 공격 패턴:** 첫 번째 온열장치 파괴 시, 보스는 5초마다 `Muzzle2`에서 추가 기본 공격을 발사합니다.
*   **폭발 효과 개선:** 유도 미사일 폭발 시 화면 흔들림 및 범위 데미지 효과가 적용됩니다.
*   **얼어붙는 모션:** 모든 온열장치 파괴 시, 보스는 얼어붙는 애니메이션을 재생합니다.
*   **사망 모션:** 보스 체력이 0이 되면, 아래로 가라앉으며 기울어지는 애니메이션을 재생한 후 사라집니다.
*   **보스 위치 고정:** 보스가 유휴 상태일 때 발사체에 맞아 움직이지 않도록 물리적 상호작용을 최소화했습니다.
*   **얼음벽 회피 공격:** 보스의 공격이 얼음벽을 감지하면 궤도를 높여 벽 위를 지나가도록 수정되었습니다.

### 2. 플레이어
*   **냉동 게이지 디버프:** 냉동 게이지로 인한 속도 감소 디버프는 게이지가 완전히 0이 되어야만 해제됩니다. (기존: 100% 미만 시 해제)

### 3. 카메라
*   **플레이어 하단 고정:** 카메라가 플레이어를 화면 하단에 배치하도록 조정되었습니다.
*   **맵 경계 제한:** 카메라가 맵의 경계를 벗어나지 않도록 시야가 제한됩니다.

### 4. UI
*   **온열장치 체력 표시:** 각 보스 온열장치의 현재 체력이 화면 좌측 상단에 표시됩니다.
*   **디버그 리셋 버튼:** 게임 씬을 즉시 다시 시작하는 디버그 버튼이 추가되었습니다.

### 5. 시각 효과
*   **차가운 바람 이펙트:** `RefreezeWindTimer`가 발생할 때마다 차가운 바람이 부는 듯한 파티클 이펙트가 화면에 표시됩니다.
*   **눈 내리는 효과:** 맵에 눈이 내리는 파티클 효과가 추가되었습니다. 이펙트는 카메라를 따라다니며, 크기가 조정되었습니다.

### 6. 디버그 도구
*   **온열장치 데미지 버튼:** 모든 보스 온열장치에 50 데미지를 즉시 입히는 디버그 버튼이 추가되었습니다.
*   **리셋 버튼:** 게임 씬을 즉시 다시 시작하는 디버그 버튼이 추가되었습니다.

### 7. 버그 수정
*   보스 온열장치 파괴 시 보스가 과열 상태에 진입하지 않던 문제 (신호 연결 누락) 수정.
*   보스 사망 시 가라앉는 애니메이션이 재생되지 않던 문제 (노드 프로세스 비활성화) 수정.
*   개발 과정에서 발생한 파서 오류 및 노드 경로 문제 수정.
*   유도 미사일이 플레이어에게 폭발하지 않던 문제 (그룹 및 함수명 불일치) 수정.
*   보스 기본 공격의 외곽선 셰이더가 올바르게 표시되지 않던 문제 (셰이더 코드 및 이미지 가져오기 설정 관련) 수정.

-----------------------------------------------------
1. 핵심 시스템
-----------------------------------------------------

### 1.1. 얼음 타일 시스템 (`tile_map.gd`)

*   **타일 상태:** 맵의 타일은 "일반(NORMAL)", "얼음(ICE)", "녹은 얼음(MELTED)" 세 가지 상태를 가집니다. 타일의 상태는 플레이어의 `is_on_ice` 변수와 냉동 게이지에 영향을 줍니다.
*   **얼음 녹이기:** `explosion.gd`의 폭발 반경 내에 있는 얼음 타일은 `melt_ice_in_area` 함수에 의해 "녹은 얼음" 상태로 변경됩니다. 이 정보는 `melted_tiles` 딕셔너리에 저장됩니다.
*   **얼어붙는 바람 (전역 재얼림):** 15초마다 `RefreezeWindTimer`가 타임아웃되어 `_on_refreeze_wind_timeout` 함수를 호출합니다. 이 함수는 `melted_tiles`에 기록된 모든 타일을 원래의 "얼음" 상태로 되돌리고, 맵의 모든 "맵 온열장치"를 끕니다. **이때 차가운 바람 이펙트가 화면에 표시됩니다.**
*   **바람과 플레이어:** "얼어붙는 바람"이 불 때, 플레이어의 `current_freeze_gauge`가 30만큼 즉시 상승합니다.

### 1.2. 냉동 게이지 시스템 (`player.gd`)

*   **게이지 변화:**
	*   **증가:** "얼음" 타일 위에서 초당 8, "녹은 얼음" 타일 위에서 초당 4씩 증가합니다. "얼어붙는 바람"이 불면 30이 즉시 증가합니다.
	*   **감소:** "맵 온열장치"(`heater.gd`)의 `WarmAura` 범위 내에 있으면 초당 15씩 감소합니다.
*   **얼어붙음 상태:** 냉동 게이지가 100에 도달하면 플레이어는 "얼어붙음(frozen)" 상태가 되어 이동 속도와 가속도가 50% 감소하는 디버프를 받습니다. **이 디버프는 냉동 게이지가 완전히 0이 되어야만 해제됩니다.**

### 1.3. 화면 흔들림 (`MainCamera.gd`)

*   **구현:** `shake(strength, duration)` 함수를 통해 구현됩니다. 이 함수는 `Tween`을 사용하여 카메라의 `offset` 속성을 짧은 시간 동안 무작위로 변경했다가 다시 `Vector2.ZERO`로 되돌리는 과정을 반복하여 화면 흔들림 효과를 만듭니다.
*   **트리거:** 플레이어 또는 보스의 포탄(`포탄.gd`)이 폭발할 때 `create_explosion` 함수 내에서 `get_tree().get_first_node_in_group("camera").shake()`를 호출하여 효과를 발동시킵니다.
*   **카메라 위치 및 제한:** 카메라가 플레이어를 화면 하단에 배치하도록 조정되었으며, 맵의 경계를 벗어나지 않도록 시야가 제한됩니다.

-----------------------------------------------------
2. 플레이어 (`player.gd`)
-----------------------------------------------------

*   **노드 타입:** `CharacterBody2D`
*   **이동:**
	*   **일반 바닥:** `Input.get_axis`로 입력을 받아 `move_toward`로 부드럽게 가속/감속합니다.
	*   **얼음 바닥:** `is_on_ice`가 `true`일 때, 마찰력(`FRICTION_ICE`)이 거의 0에 가깝게 설정되어 미끄러지는 움직임을 구현합니다.
*   **냉동 게이지:** 상단의 "핵심 시스템" 섹션을 참조하십시오.
*   **온열장치 상호작용:** `heater.gd`의 `WarmAura`(`Area2D`) 범위에 들어가면 `start_warming_up()`이 호출되어 `is_warming_up` 상태가 되고, 냉동 게이지가 감소하기 시작합니다.

-----------------------------------------------------
3. 보스 - 쇄빙선 (`쇄빙선.gd`)
-----------------------------------------------------

*   **노드 타입:** `CharacterBody2D`
*   **핵심 기믹:** 보스는 맵에 배치된 여러 개의 "보스 온열장치"(`heaters` 그룹)와 상호작용합니다. 이 온열장치들이 파괴될 때마다 보스의 패턴이 변화합니다.
*   **기본 공격:** `AttackTimer`에 맞춰 주기적으로 플레이어의 예상 위치에 포물선 포탄을 발사합니다. `_calculate_target_position` 함수는 Raycast를 통해 지형의 높이를 계산하여 정확한 목표 지점을 설정합니다.
*   **과열 시스템:**
	*   모든 "보스 온열장치"가 파괴되면(`heat_sinks_destroyed >= total_heat_sinks`), `start_overheating()` 함수가 호출됩니다.
	*   과열 상태에서는 모든 공격 타이머가 멈추고, `OverheatDamageTimer`가 매초 `_on_overheat_timer_timeout`을 호출하여 보스 스스로 100의 데미지를 입습니다. **이때 보스는 얼어붙는 애니메이션을 재생합니다.**
	*   **사망 모션:** 보스 체력이 0이 되면, 즉시 사라지는 대신 아래로 가라앉으며 기울어지는 애니메이션을 재생한 후 씬에서 제거됩니다.

### 3.1. 기믹 1: 유도 미사일 (상시 활성화)

*   **발동:** 이제 유도 미사일은 게임 시작부터 상시 발사됩니다.
*   **동작:** `_on_homing_missile_timer_timeout`이 호출되면, 플레이어 위치를 기준으로 유도 미사일(`homing_missile.gd`)을 발사합니다.
*   **유도 미사일 상세 (`homing_missile.gd`):**
	*   처음에는 포물선 궤적으로 날아가다가, 플레이어와의 거리가 `homing_activation_range`(800px) 이내로 들어오면 중력을 끄고(`gravity_scale = 0.0`) 그 순간의 플레이어 방향으로 한 번 방향을 꺾어 돌진합니다. **폭발 시 화면 흔들림 및 범위 데미지 효과가 적용됩니다.**

### 3.2. 기믹 2: 추가 기본 공격 (첫 온열장치 파괴 시)

*   **발동:** 첫 번째 "보스 온열장치"가 파괴되면(`heat_sinks_destroyed == 1`), `second_attack_timer`가 시작되어 5초마다 추가 기본 공격을 발사합니다.
*   **동작:** 이 추가 공격은 `Muzzle2`에서 발사되며, 기존 기본 공격과 동일한 로직을 따릅니다.

### 3.3. 기믹 3: 방어벽 생성 (온열장치 HP 50% 이하 시)

*   **발동:** "보스 온열장치"의 HP가 50% 이하가 되면 `spawn_wall_requested` 시그널을 보스에게 보냅니다.
*   **돌진:** `_on_spawn_wall_requested`가 호출되면, 보스는 `is_charging_for_wall` 상태가 되어 플레이어 방향으로 `WALL_CHARGE_SPEED`의 속도로 돌진합니다.
*   **생성:** 돌진 중 벽(TileMap)과 충돌하면, `is_charging_for_wall`을 `false`로 바꾸고 `spawn_ice_wall` 함수를 호출하여 충돌 지점 앞에 `iceWall.tscn`을 생성합니다.
*   **위치 복귀:** 방어벽 생성 후, `is_returning` 상태가 되어 `original_position`(보스의 초기 위치)으로 `WALL_CHARGE_SPEED`의 속도로 되돌아갑니다. 원래 위치에 도착하면 `is_returning` 상태가 해제됩니다.

-----------------------------------------------------
4. 환경 및 오브젝트
-----------------------------------------------------

### 4.1. 맵 온열장치 (`heater.gd`)

*   **상태:** `is_on` 변수로 켜짐/꺼짐 상태를 관리합니다. `turn_on()`, `turn_off()` 함수로 제어됩니다.
*   **기능:**
	*   **켜짐:** 플레이어의 포탄에 맞거나, 보스 포탄의 폭발 범위에 포함되면 `turn_on()`이 호출됩니다. 켜진 상태에서는 `WarmAura`가 활성화되어 범위 내 플레이어의 냉동 게이지를 감소시킵니다.
	*   **꺼짐:** "얼어붙는 바람"이 불 때 `tile_map.gd`에 의해 `turn_off()`가 호출됩니다.

### 4.2. 얼음 방어벽 (`iceWall.gd`)

*   **HP:** `@export var hp: int = 3`으로 설정되어 있어, 3번의 타격을 받으면 파괴됩니다.
*   **생성 및 소멸:** 보스가 생성하며, `take_damage` 함수를 통해 HP가 0이 되면 파괴 애니메이션을 재생한 후 `queue_free()`로 사라집니다.

### 4.3. 포탄 및 폭발 (`포탄.gd`, `explosion.gd`)

*   **포탄:** `RigidBody2D`이며, 발사된 후 5초 뒤 자동으로 사라집니다. `_physics_process`에서 자신의 이동 방향(`linear_velocity`)에 맞춰 몸체 각도를 계속 회전시킵니다.
*   **폭발:** 포탄이 충돌하면 `create_explosion` 함수를 통해 `ExplosionScene`을 생성합니다. `explosion.gd`는 자신의 `Area2D` 내에 있는 모든 객체의 `take_damage` 함수를 호출하여 광역 피해를 주고, `tile_map.gd`의 `melt_ice_in_area`를 호출하여 주변 얼음을 녹입니다.

### 4.4. 차가운 바람 이펙트 (`ColdWindEffect.tscn`, `ColdWindEffect.gd`)
*   **역할:** `RefreezeWindTimer`가 발생할 때마다 화면에 차가운 바람이 부는 듯한 시각 효과를 제공합니다.
*   **구현:** `CPUParticles2D` 노드를 사용하여 구현되었으며, 파티클 방출이 완료되면 스스로 씬에서 제거됩니다.

-----------------------------------------------------
5. UI (`GameUI.gd`)
-----------------------------------------------------

*   **역할:** `CanvasLayer`를 통해 게임 월드와 분리된 UI를 렌더링합니다.
*   **기능:** `_process` 함수 내에서 "player", "boss", "heaters" 그룹의 노드를 찾아, 그들의 `health_updated` 및 `freeze_gauge_changed` 시그널에 연결합니다. 시그널을 수신하면 `PlayerHealthLabel`, `BossHealthLabel`, `FreezeGaugeLabel`의 텍스트를 업데이트합니다. **각 보스 온열장치의 체력은 화면 좌측 상단에 표시됩니다.**

### 5.1. 디버그 UI (`DebugUI.gd`)
*   **역할:** 게임 플레이 중 디버깅을 위한 버튼들을 제공합니다.
*   **기능:**
	*   **ToggleHomingButton:** 유도 미사일 패턴을 켜고 끕니다.
	*   **SpawnWallButton:** 보스가 방어벽을 생성하도록 트리거합니다.
	*   **DamageHeatersButton:** 모든 보스 온열장치에 50 데미지를 즉시 입힙니다.

-----------------------------------------------------
6. 기술 사양: 충돌 레이어 및 마스크 (현재 상태)
-----------------------------------------------------
| 레이어 이름 (번호) | 객체 | LAYER | MASK | 비고 |
| :--- | :--- | :---: | :---: | :--- |
| `world` (1) | `TileMap` | **1** | - | 지형 |
| `player` (2) | `Player` | **2** | **57** | `world`(1), `enemy`(8), `enemy_bullet`(16), `wall`(32)와 충돌. |
| `player_bullet` (3)| (없음) | - | - | 스테이지 2에서는 플레이어가 총알을 쏘지 않음. |
| `enemy` (4) | `쇄빙선` (보스) | **8** | **7** | `world`(1), `player`(2), `player_bullet`(4)와 충돌. |
| `enemy_bullet` (5)| `포탄`, `유도 미사일` | **16** | **3** | `world`(1), `player`(2)와 충돌. |
| `wall` (6) | `IceWall` | **32** | **5** | `world`(1), `player_bullet`(4)와 충돌. |
| `hitbox` (7) | 보스 온열장치 | **64** | **4** | `player_bullet`(4)와 충돌. |
| (N/A) | 맵 온열장치 | 1 | 1 | `StaticBody2D` 기본값. |
| (N/A) | 맵 온열장치 Aura | - | **2** | `Area2D`로, `player`(2)를 감지. |
