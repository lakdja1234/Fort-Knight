[gd_scene load_steps=15 format=3 uid="uid://pxqgegm6a54e"]

[sub_resource type="GDScript" id="GDScript_m1ix0"]
script/source = "# player.gd (Refactored for Ammo Type Toggle & Skill Cooldown)
extends CharacterBody2D

# --- Signals ---
signal game_over
signal health_updated(current_hp)
signal freeze_gauge_changed(current_value, max_value)

# --- Physics ---
var gravity = ProjectSettings.get_setting(\"physics/2d/default_gravity\")

# --- Scene References ---
@export var bullet_scene = load(\"res://스테이지3/Bullet.tscn\")
const HomingMissileScene = preload(\"res://스테이지2/player_homing_missile.tscn\")


# --- HUD & Node References ---
@onready var health_bar = $PlayerHUD/HUDContainer/PlayerInfoUI/VBoxContainer/HealthBar
@onready var charge_bar = $PlayerHUD/HUDContainer/PlayerInfoUI/VBoxContainer/ChargeBar
@onready var cooldown_timer = $CooldownTimer
@onready var cannon_pivot = $CannonPivot
@onready var fire_point = $CannonPivot/FirePoint
@onready var ice_map_layer: TileMapLayer = null # For Stage 2
@onready var background = get_node_or_null(\"/root/TitleMap/Background\") # For Stage 3
@onready var homing_cooldown_timer = $HomingCooldownTimer
@onready var skill_cooldown_bar = $PlayerHUD/HUDContainer/SlotUI/Slot1/SkillCooldownBar


# --- Movement Variables ---
const SPEED_ORIGINAL = 400.0
const ACCELERATION_NORMAL_ORIGINAL = 1000.0
const ACCELERATION_ICE_ORIGINAL = 500.0
const FRICTION_NORMAL = 1000.0
const FRICTION_ICE = 0.001
var current_speed = SPEED_ORIGINAL
var current_accel_normal = ACCELERATION_NORMAL_ORIGINAL
var current_accel_ice = ACCELERATION_ICE_ORIGINAL
var is_on_ice = false
var current_floor_type: String = \"NORMAL\"

# --- Aiming Variables ---
const AIM_SPEED = 2.0

# --- Firing System Variables ---
const MIN_FIRE_POWER = 500.0
const MAX_FIRE_POWER = 2000.0
const CHARGE_RATE = 1000.0
const COOLDOWN_DURATION = 2.0
var is_charging = false
var current_power = MIN_FIRE_POWER
var can_fire = true
var is_homing_missile_selected = false

# --- Skill Cooldown ---
const HOMING_COOLDOWN = 10.0
var is_homing_on_cooldown = false

# --- Player Stats ---
var max_hp = 100
var hp = max_hp

# --- Stage 2 Specific Exportable Settings ---
@export var player_explosion_radius: float = 300.0
@export var player_projectile_scale: Vector2 = Vector2(1.0, 1.0)

# --- HUD Color Variables ---
const CHARGE_COLOR = Color(\"orange\")
const COOLDOWN_COLOR = Color.RED
const HEALTH_FULL_COLOR = Color.GREEN
const HEALTH_EMPTY_COLOR = Color.RED

# --- Freeze Gauge Variables (for Stage 2) ---
var max_freeze_gauge: float = 100.0
var current_freeze_gauge: float = 0.0
const FREEZE_RATE_ICE: float = 7.0
const FREEZE_RATE_MELTED: float = 2.0
var warm_rate: float = 20.0
var is_warming_up: bool = false
var is_frozen: bool = false

# --- Misc ---
var bullet_path_points = []
const BULLET_PATH_DURATION = 2.0

# ==============================================================================
#  CORE FUNCTIONS
# ==============================================================================

func _ready():
	add_to_group(\"player\")
	
	# --- HUD Initialization ---
	if health_bar:
		health_bar.max_value = max_hp
		update_health_bar()
	if charge_bar:
		setup_bar_for_charging()
	
	# --- Cooldown UI Setup ---
	if skill_cooldown_bar:
		skill_cooldown_bar.max_value = HOMING_COOLDOWN
		skill_cooldown_bar.value = 0
		skill_cooldown_bar.visible = false
	
	homing_cooldown_timer.wait_time = HOMING_COOLDOWN
	homing_cooldown_timer.timeout.connect(_on_homing_cooldown_timer_timeout)

	# --- Stage 2 Specific Initialization ---
	ice_map_layer = get_tree().get_first_node_in_group(\"ground_tilemap\")
	if ice_map_layer != null:
		emit_signal(\"freeze_gauge_changed\", current_freeze_gauge, max_freeze_gauge)
	
	# Emit health for any listening UIs
	emit_signal(\"health_updated\", hp)

func _unhandled_input(event):
	if event is InputEventAction and event.action == \"use_skill\" and event.is_just_pressed():
		is_homing_missile_selected = not is_homing_missile_selected
		get_viewport().set_input_as_handled()

func _physics_process(delta):
	# --- Input Handling for Ammo Toggle ---
	if Input.is_action_just_pressed(\"use_skill\"):
		is_homing_missile_selected = not is_homing_missile_selected
		# Add feedback here if needed, e.g., update UI
		
	# --- Update Homing Cooldown UI ---
	if is_homing_on_cooldown:
		skill_cooldown_bar.value = homing_cooldown_timer.time_left

	# --- Gravity ---
	if not is_on_floor():
		velocity.y += gravity * delta

	# --- Stage 2: Floor Type Check & Freeze Gauge Update ---
	if is_instance_valid(ice_map_layer):
		if ice_map_layer.has_method(\"get_player_floor_type\"):
			current_floor_type = ice_map_layer.get_player_floor_type(self)
			is_on_ice = (current_floor_type == \"ICE\")
		else:
			is_on_ice = false
		update_freeze_gauge(delta)
	else:
		is_on_ice = false

	# --- Movement ---
	var direction = Input.get_axis(\"move_left\", \"move_right\")
	var accel = ACCELERATION_NORMAL_ORIGINAL
	var friction = FRICTION_NORMAL
	var speed = SPEED_ORIGINAL

	# Apply debuffs if frozen
	if is_frozen:
		speed = SPEED_ORIGINAL * 0.5
		accel = ACCELERATION_NORMAL_ORIGINAL * 0.5

	# Apply ice physics if on ice
	if is_on_ice:
		if is_frozen:
			accel = ACCELERATION_ICE_ORIGINAL * 0.5
		else:
			accel = ACCELERATION_ICE_ORIGINAL
		friction = FRICTION_ICE

	# Apply movement
	if direction:
		velocity.x = move_toward(velocity.x, direction * speed, accel * delta)
	else:
		velocity.x = move_toward(velocity.x, 0.0, friction * delta)
	
	move_and_slide()

	# --- Aiming ---
	var aim_direction = Input.get_axis(\"aim_up\", \"aim_down\")
	if cannon_pivot:
		cannon_pivot.rotation += aim_direction * AIM_SPEED * delta
		cannon_pivot.rotation = clamp(cannon_pivot.rotation, -PI, 0.0)
	
	# --- Firing & Cooldown ---
	if can_fire:
		if Input.is_action_just_pressed(\"fire\"):
			if is_homing_missile_selected and is_homing_on_cooldown:
				# Prevent charging if homing missile is on cooldown
				return
			is_charging = true
			current_power = MIN_FIRE_POWER
			if charge_bar: charge_bar.value = current_power
		if is_charging and Input.is_action_pressed(\"fire\"):
			current_power = min(current_power + CHARGE_RATE * delta, MAX_FIRE_POWER)
			if charge_bar: charge_bar.value = current_power
		if is_charging and Input.is_action_just_released(\"fire\"):
			is_charging = false
			can_fire = false 
			fire_bullet(current_power)
			if not is_homing_missile_selected: # Only use main cooldown for normal bullet
				if cooldown_timer: 
					cooldown_timer.start()
					setup_bar_for_cooldown()
			else: # Homing missile has its own cooldown logic inside fire_bullet
				can_fire = true # Allow normal bullet to be fired
	elif charge_bar and cooldown_timer.time_left > 0 and not is_homing_on_cooldown:
		charge_bar.value = cooldown_timer.time_left

	# --- Stage 3: Shader Update ---
	if is_instance_valid(background) and background.material:
		update_shader_lights()


# ==============================================================================
#  ACTION FUNCTIONS
# ==============================================================================

func fire_bullet(power: float):
	var projectile_scene
	if is_homing_missile_selected:
		if is_homing_on_cooldown:
			return # Extra check
		projectile_scene = HomingMissileScene
		is_homing_on_cooldown = true
		homing_cooldown_timer.start()
		skill_cooldown_bar.visible = true
		skill_cooldown_bar.value = HOMING_COOLDOWN
	else:
		projectile_scene = bullet_scene
		
	if not projectile_scene:
		if is_homing_missile_selected:
			printerr(\"Player cannot fire: Homing Missile Scene is not set!\")
		else:
			printerr(\"Player cannot fire: Bullet Scene is not set!\")
		return

	var bullet = projectile_scene.instantiate()
	get_parent().add_child(bullet)
	
	if bullet.has_method(\"set_shooter\"):
		bullet.set_shooter(self)
	if \"owner_node\" in bullet:
		bullet.owner_node = self

	if bullet.has_method(\"set_explosion_radius\"):
		bullet.set_explosion_radius(player_explosion_radius)
	if bullet.has_method(\"set_projectile_scale\"):
		bullet.set_projectile_scale(player_projectile_scale)
	
	bullet.global_position = fire_point.global_position
	bullet.global_rotation = cannon_pivot.global_rotation
	bullet.linear_velocity = bullet.transform.x * power

func take_damage(amount):
	hp = max(hp - amount, 0)
	if health_bar:
		update_health_bar()
	emit_signal(\"health_updated\", hp)
	var tween = create_tween().set_loops(2)
	tween.tween_property(self, \"modulate\", Color.RED, 0.15)
	tween.tween_property(self, \"modulate\", Color.WHITE, 0.15)
	if hp <= 0:
		await tween.finished
		emit_signal(\"game_over\")
		queue_free()

# ==============================================================================
#  HUD AND VISUALS
# ==============================================================================

func update_health_bar():
	if not health_bar: return
	health_bar.value = hp
	var health_ratio = float(hp) / float(max_hp)
	var current_color = HEALTH_FULL_COLOR.lerp(HEALTH_EMPTY_COLOR, 1.0 - health_ratio)
	var stylebox_original = health_bar.get_theme_stylebox(\"fill\")
	if stylebox_original:
		var stylebox_copy = stylebox_original.duplicate()
		stylebox_copy.bg_color = current_color
		health_bar.add_theme_stylebox_override(\"fill\", stylebox_copy)

func setup_bar_for_charging():
	if not charge_bar: return
	charge_bar.fill_mode = ProgressBar.FILL_BEGIN_TO_END
	charge_bar.min_value = MIN_FIRE_POWER
	charge_bar.max_value = MAX_FIRE_POWER
	charge_bar.value = MIN_FIRE_POWER
	var stylebox_original = charge_bar.get_theme_stylebox(\"fill\")
	if stylebox_original:
		var stylebox_copy = stylebox_original.duplicate()
		stylebox_copy.bg_color = CHARGE_COLOR
		charge_bar.add_theme_stylebox_override(\"fill\", stylebox_copy)

func setup_bar_for_cooldown():
	if not charge_bar or not cooldown_timer: return
	charge_bar.fill_mode = ProgressBar.FILL_BEGIN_TO_END
	charge_bar.min_value = 0.0
	charge_bar.max_value = COOLDOWN_DURATION
	charge_bar.value = COOLDOWN_DURATION
	var stylebox_original = charge_bar.get_theme_stylebox(\"fill\")
	if stylebox_original:
		var stylebox_copy = stylebox_original.duplicate()
		stylebox_copy.bg_color = COOLDOWN_COLOR
		charge_bar.add_theme_stylebox_override(\"fill\", stylebox_copy)

func update_shader_lights():
	var light_positions = []
	light_positions.append(background.to_local(global_position))
	var bullets = get_tree().get_nodes_in_group(\"bullets\")
	for bullet in bullets:
		bullet_path_points.append({\"position\": background.to_local(bullet.global_position), \"timestamp\": Time.get_ticks_msec()})
	var current_time = Time.get_ticks_msec()
	bullet_path_points = bullet_path_points.filter(func(point):
		return current_time - point.timestamp < BULLET_PATH_DURATION * 1000
	)
	bullet_path_points.sort_custom(func(a, b): return a.timestamp > b.timestamp)
	var max_points = 127
	var points_to_add = bullet_path_points.slice(0, min(bullet_path_points.size(), max_points))
	for point in points_to_add:
		light_positions.append(point.position)
	background.material.set_shader_parameter(\"light_positions\", light_positions)
	background.material.set_shader_parameter(\"light_count\", light_positions.size())

# ==============================================================================
#  SIGNAL CALLBACKS
# ==============================================================================

func _on_cooldown_timer_timeout():
	can_fire = true
	setup_bar_for_charging()

func _on_homing_cooldown_timer_timeout():
	is_homing_on_cooldown = false
	if skill_cooldown_bar:
		skill_cooldown_bar.visible = false

func _on_hitbox_body_entered(body):
	if body.is_in_group(\"bullets\"):
		if \"shooter\" in body and body.shooter == self:
			return
		if \"owner_node\" in body and body.owner_node == self:
			return
		take_damage(10)
		if body.has_method(\"explode\"):
			body.explode()
		else:
			body.queue_free()

func _on_hitbox_area_entered(area):
	if area.is_in_group(\"stalactites\") and area.is_falling:
		take_damage(20)

# ==============================================================================
#  STAGE 2 SPECIFIC FUNCTIONS
# ==============================================================================

func update_freeze_gauge(delta: float):
	if is_warming_up:
		current_freeze_gauge = max(current_freeze_gauge - warm_rate * delta, 0.0)
	elif current_floor_type == \"ICE\":
		current_freeze_gauge = min(current_freeze_gauge + FREEZE_RATE_ICE * delta, max_freeze_gauge)
	elif current_floor_type == \"MELTED\":
		current_freeze_gauge = min(current_freeze_gauge + FREEZE_RATE_MELTED * delta, max_freeze_gauge)
	
	emit_signal(\"freeze_gauge_changed\", current_freeze_gauge, max_freeze_gauge)
	
	if current_freeze_gauge >= max_freeze_gauge and not is_frozen:
		is_frozen = true
		apply_freeze_debuff(true)
	elif current_freeze_gauge == 0 and is_frozen:
		is_frozen = false
		apply_freeze_debuff(false)

func apply_freeze_debuff(frozen: bool):
	if frozen:
		# print(\"!!! 얼어붙음! 기동력 저하 !!!\")
		pass
	else:
		# print(\"!!! 해동됨! 기동력 복구 !!!\")
		pass
	# The actual speed change is handled in _physics_process now

func start_warming_up():
	is_warming_up = true

func stop_warming_up():
	is_warming_up = false
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_tdg3f"]
size = Vector2(48, 24)

[sub_resource type="Gradient" id="Gradient_kne1u"]
offsets = PackedFloat32Array(0, 0.78)
colors = PackedColorArray(1, 1, 1, 1, 0, 0, 0, 1)

[sub_resource type="GradientTexture2D" id="GradientTexture2D_e80uo"]
gradient = SubResource("Gradient_kne1u")
fill = 1
fill_from = Vector2(0.4906542, 0.5140187)

[sub_resource type="CompressedTexture2D" id="CompressedTexture2D_b720a"]
load_path = "res://.godot/imported/tanks_turret2.png-458684a2ee68e13f1a26b28918a82b9b.ctex"

[sub_resource type="CompressedTexture2D" id="CompressedTexture2D_7y4uo"]
load_path = "res://.godot/imported/tanks_tankGreen_body3.png-095aee3cfa873995aa559961bc52ef8f.ctex"

[sub_resource type="CompressedTexture2D" id="CompressedTexture2D_eu72d"]
load_path = "res://.godot/imported/partSlot.png-5ebb21d33be5a765cd1e0837bc582bcf.ctex"

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_player_info_border"]
bg_color = Color(0, 0, 0, 0.501961)
border_width_left = 1
border_width_top = 1
border_width_right = 1
border_width_bottom = 1
border_color = Color(0.8, 0.8, 0.8, 0.6)
corner_radius_top_left = 4
corner_radius_top_right = 4
corner_radius_bottom_right = 4
corner_radius_bottom_left = 4
expand_margin_left = 2.0
expand_margin_top = 2.0
expand_margin_right = 2.0
expand_margin_bottom = 2.0

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_health_bg"]
bg_color = Color(0, 0, 0, 0.392157)
corner_radius_top_left = 3
corner_radius_top_right = 3

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_health_fg"]
bg_color = Color(0.262745, 0.835294, 0.380392, 1)
corner_radius_top_left = 3
corner_radius_top_right = 3

[sub_resource type="CanvasItemMaterial" id="CanvasItemMaterial_unshaded"]
light_mode = 1

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_charge_bg"]
bg_color = Color(0, 0, 0, 0.392157)
corner_radius_bottom_right = 3
corner_radius_bottom_left = 3

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_charge_fg"]
bg_color = Color(1, 0.6, 0, 1)
corner_radius_bottom_right = 3
corner_radius_bottom_left = 3

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_skill_cooldown"]
bg_color = Color(0.2, 0.2, 0.2, 0.7)

[node name="Player" type="CharacterBody2D"]
collision_layer = 2
collision_mask = 57
script = SubResource("GDScript_m1ix0")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2(0, -4)
shape = SubResource("RectangleShape2D_tdg3f")
one_way_collision = true

[node name="Hitbox" type="Area2D" parent="."]
collision_layer = 2
collision_mask = 57

[node name="CollisionShape2D" type="CollisionShape2D" parent="Hitbox"]
position = Vector2(0, -4)
shape = SubResource("RectangleShape2D_tdg3f")

[node name="PointLight2D" type="PointLight2D" parent="."]
scale = Vector2(1.5, 1.4999999)
texture = SubResource("GradientTexture2D_e80uo")
texture_scale = 3.0

[node name="CannonPivot" type="Node2D" parent="."]
position = Vector2(0, -5)

[node name="CannonSprite" type="Sprite2D" parent="CannonPivot"]
position = Vector2(14, 0)
rotation = 6.2831855
scale = Vector2(0.5, 0.5)
texture = SubResource("CompressedTexture2D_b720a")

[node name="FirePoint" type="Marker2D" parent="CannonPivot"]
position = Vector2(29, 0)

[node name="Sprite2D" type="Sprite2D" parent="."]
position = Vector2(0, -5)
scale = Vector2(0.5, 0.5)
texture = SubResource("CompressedTexture2D_7y4uo")

[node name="CooldownTimer" type="Timer" parent="."]
wait_time = 2.0
one_shot = true

[node name="HomingCooldownTimer" type="Timer" parent="."]
wait_time = 10.0
one_shot = true

[node name="PlayerHUD" type="CanvasLayer" parent="."]

[node name="HUDContainer" type="VBoxContainer" parent="PlayerHUD"]
anchors_preset = 7
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
offset_left = -125.0
offset_top = -100.0
offset_right = 125.0
grow_horizontal = 2
grow_vertical = 0
theme_override_constants/separation = 0

[node name="SlotUI" type="HBoxContainer" parent="PlayerHUD/HUDContainer"]
layout_mode = 2
alignment = 1

[node name="Slot1" type="TextureRect" parent="PlayerHUD/HUDContainer/SlotUI"]
custom_minimum_size = Vector2(50, 50)
layout_mode = 2
texture = SubResource("CompressedTexture2D_eu72d")
expand_mode = 1

[node name="SkillCooldownBar" type="ProgressBar" parent="PlayerHUD/HUDContainer/SlotUI/Slot1"]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme_override_styles/fill = SubResource("StyleBoxFlat_skill_cooldown")
max_value = 10.0
step = 0.01
value = 10.0
fill_mode = 3
show_percentage = false

[node name="Slot2" type="TextureRect" parent="PlayerHUD/HUDContainer/SlotUI"]
custom_minimum_size = Vector2(50, 50)
layout_mode = 2
texture = SubResource("CompressedTexture2D_eu72d")
expand_mode = 1

[node name="Slot3" type="TextureRect" parent="PlayerHUD/HUDContainer/SlotUI"]
custom_minimum_size = Vector2(50, 50)
layout_mode = 2
texture = SubResource("CompressedTexture2D_eu72d")
expand_mode = 1

[node name="PlayerInfoUI" type="PanelContainer" parent="PlayerHUD/HUDContainer"]
layout_mode = 2
theme_override_styles/panel = SubResource("StyleBoxFlat_player_info_border")

[node name="VBoxContainer" type="VBoxContainer" parent="PlayerHUD/HUDContainer/PlayerInfoUI"]
layout_mode = 2
theme_override_constants/separation = 0
alignment = 1

[node name="HealthBar" type="ProgressBar" parent="PlayerHUD/HUDContainer/PlayerInfoUI/VBoxContainer"]
custom_minimum_size = Vector2(500, 30)
layout_mode = 2
theme_override_styles/background = SubResource("StyleBoxFlat_health_bg")
theme_override_styles/fill = SubResource("StyleBoxFlat_health_fg")
value = 100.0
show_percentage = false

[node name="ChargeBar" type="ProgressBar" parent="PlayerHUD/HUDContainer/PlayerInfoUI/VBoxContainer"]
material = SubResource("CanvasItemMaterial_unshaded")
custom_minimum_size = Vector2(500, 30)
layout_mode = 2
theme_override_styles/background = SubResource("StyleBoxFlat_charge_bg")
theme_override_styles/fill = SubResource("StyleBoxFlat_charge_fg")
show_percentage = false

[connection signal="area_entered" from="Hitbox" to="." method="_on_hitbox_area_entered"]
[connection signal="body_entered" from="Hitbox" to="." method="_on_hitbox_body_entered"]
[connection signal="timeout" from="CooldownTimer" to="." method="_on_cooldown_timer_timeout"]
