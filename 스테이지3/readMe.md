# 3스테이지 기술 명세서
=====================================================
* 최종 업데이트: 2025-11-19
* 프로젝트 폴더: `fortknight-godot`

-----------------------------------------------------
## 1. 게임 흐름 및 핵심 시스템
-----------------------------------------------------

### 1.1. 게임 시작 및 화면 전환

*   **전역 화면 전환:** `SceneTransition` (`fade_layer.tscn`) Autoload 싱글톤을 통해 모든 화면 전환 시 0.5초간의 페이드 인/아웃 효과를 제공합니다.
*   **게임 시작:** `project.godot` 설정에 따라, 게임은 `res://title_screen.tscn`에서 시작됩니다.
*   **화면 흐름:**
    1.  **`title_screen` (메인 화면):** `Timer`로 깜빡이는 `--PRESS ANY KEY--` 문구가 표시되며, 아무 키나 누르면 다음 화면으로 전환됩니다.
    2.  **`stage_selection` (스테이지 선택):** 각 스테이지 영역에 마우스를 올리면 `Theme` 리소스를 통해 하이라이트 효과가 표시됩니다. 영역을 300ms 안에 더블 클릭하면 해당 준비 화면으로 넘어갑니다.
    3.  **`stage_3_ready` (준비 화면):** `AnimationPlayer`를 통해 스테이지 이미지, 검은색 오버레이, 설명 텍스트가 순차적으로 나타난 후, 스페이스바를 누르면 메인 게임 씬으로 진입합니다.
    4.  **`map.tscn` (메인 게임):** 실제 게임 플레이가 이루어지는 씬입니다.
*   **화면 해상도:** `project.godot` 파일에 `display/window` 섹션이 추가되어, 게임 창의 기본 해상도는 **1152x818**로 설정되어 있습니다.

### 1.2. 시야 및 렌더링 시스템

*   **기본 암전 효과:** `background_light.gdshader` 커스텀 셰이더를 통해 구현됩니다.
*   **광원 처리:** `player.gd`가 매 프레임 플레이어와 포탄의 위치를 셰이더로 전달하여 주변 시야를 밝힙니다.
*   **오브젝트 가시성:** 종유석, 횃불 등은 `light_mask`를 통해 `PointLight2D`의 빛을 받아야 보이며, `BrightSpot` 같은 특정 오브젝트는 `blend_mode`를 `BLEND_MODE_ADD`로 설정하여 암전 효과를 무시하고 항상 빛나게 보입니다.

### 1.3. 게임 상태 관리 (game_manager.gd)

*   **게임 오버/클리어:** 플레이어나 보스의 HP가 0이 되면 반투명 오버레이와 함께 `Game Over` 또는 `Game Clear` UI를 표시하고 게임을 정지시킵니다. `RetryButton`을 통해 씬을 재시작할 수 있습니다.
*   **디버그 기능:** `_ready()`에서 "1기믹 (HP 50%)", "2기믹 (HP 30%)" 버튼을 동적으로 생성하여, 클릭 시 보스의 HP를 직접 수정해 기믹을 즉시 발동시킬 수 있습니다.

-----------------------------------------------------
## 2. 플레이어 (player.gd)
-----------------------------------------------------

*   **이동 및 조준:** `CharacterBody2D` 기반으로, 부드러운 가감속 이동과 상단 180도 포신 회전 제한이 구현되어 있습니다.
*   **발사 및 쿨다운:** `ProgressBar` 하나를 이용해 발사 시에는 노란색 '차징 바'로, 발사 후에는 붉은색 '쿨다운 바'로 상태를 시각적으로 전환하여 표시합니다. 쿨다운은 2초로 설정되어 있습니다.
*   **피해 피드백:** `Tween`을 이용해 피격 시 붉은색과 흰색으로 2회 깜빡이는 효과를 연출합니다.

-----------------------------------------------------
## 3. 환경 및 오브젝트
-----------------------------------------------------

### 3.1. 횃불 (torch.gd)

*   플레이어 포탄으로 점화하며, 30초 후 자동으로 소등됩니다. 보스의 2번 기믹에 의해 강제로 소등될 수 있습니다.

### 3.2. 종유석 (Stalactites.gd & Stalactite.gd)

*   **관리:** `Stalactites.gd`가 맵에 항상 5개의 종유석이 유지되도록 생성 및 리스폰을 관리합니다.
*   **낙하 및 경고:** `Stalactite.gd`는 플레이어 총알에 맞으면 낙하를 시작하며, 데미지는 40으로 설정되어 있습니다.
    *   **경고 위치:** 낙하 전, `PhysicsRayQueryParameters2D`로 바닥을 감지하여 경고 이미지를 생성합니다. 이때 경고 이미지 자체의 높이를 계산하여, **정확히 바닥 위에 표시되도록** 위치 보정 로직이 적용되었습니다.
*   **폭발 효과:** 종유석 파괴 시 나타나는 `explosion.tscn`의 애니메이션 속도가 2배 빠르게 수정되었습니다.

-----------------------------------------------------
## 4. 보스 (boss.gd)
-----------------------------------------------------

*   **핵심:** `StaticBody2D` 타입이며, 다양한 상태 변수와 타이머를 통해 복잡한 패턴과 기믹을 제어합니다.
*   **공격 로직:** `_on_attack_timer_timeout`에서 'Iterative Predict and Warn' 방식으로 플레이어의 위치를 예측하고 Raycast로 지형을 분석하여 포물선 탄도를 계산합니다. 초기 발사 속도는 1200으로 조정되었습니다.

### 4.1. 기믹 1 (HP <= 50%)

*   **실행:** 15초간 투명화 상태가 되어 무적이 되고, 매초 체력을 회복합니다.
*   **`BrightSpot` (약점):**
    *   기믹이 시작되면 벽/천장에 붉게 빛나는 `BrightSpot`이 생성됩니다.
    *   **충돌:** 플레이어의 탄환(`Bullet.tscn`)이 `BrightSpot`과 정상적으로 충돌하도록 충돌 레이어와 마스크 설정이 수정되었습니다.
    *   `BrightSpot`을 파괴하면 보스의 체력 회복이 3초간 중지되고 보스에게 소량의 피해를 줍니다.
*   **종료:** 15초가 지나면 기믹이 종료되고 보스는 다시 모습을 드러냅니다.

### 4.2. 기믹 2 (HP <= 30%)

*   맵의 모든 횃불을 강제로 소등시켜 시야를 제한하고, 3초마다 맵 상단의 종유석 중 하나를 무작위로 강제 낙하시킵니다.

-----------------------------------------------------
## 5. UI / UX 상세 구현
-----------------------------------------------------

### 5.1. 보스 체력바

*   **구현 방식:** `Boss.tscn` 씬 내에 UI 노드들이 직접 배치되어 있어, **Godot 에디터에서 드래그 앤 드롭으로 크기와 위치를 시각적으로 편집할 수 있습니다.**
*   **노드 구조 (독립적 제어):**
    *   `BossUICanvas` (`CanvasLayer`) 아래에 `HealthBarFrame` (`TextureRect`), `HealthBarFG` (`Panel`), `HealthBarLabel` (`Label`)이 **서로 동등한 형제 관계**로 존재하여, 각 요소의 독립적인 제어가 가능합니다.
*   **스타일 및 업데이트:**
    *   `boss.gd` 스크립트가 `StyleBoxFlat`을 동적으로 생성하여 `HealthBarFG`의 모서리를 둥글게 만듭니다. (`corner_radius`는 4)
    *   체력 비율에 맞춰 `HealthBarFG`의 너비를 조절하고, 체력에 따라 색상(초록/노랑/빨강)을 변경합니다.
*   **라벨 폰트:** `Boss.tscn`에서 `HealthBarLabel`의 폰트 크기는 `12`로 설정되어 있습니다.

### 5.2. 플레이어 HUD

*   화면 하단에 플레이어 체력바, 차지바, 슬롯 UI가 배치되어 있습니다.
*   `ChargeBar`는 `ProgressBar.FILL_BEGIN_TO_END` 모드로 작동하며, 발사 차징(노란색)과 쿨다운(붉은색) 상태를 표시합니다.

-----------------------------------------------------
## 6. 기술 사양: 충돌 레이어 및 마스크
-----------------------------------------------------
| 레이어 이름 (번호) | 객체 | LAYER | MASK | 비고 |
| :---------------- | :-------------------- | :---: | :---: | :--- |
| `world` (1)       | `TileMap`             | **1** | - | 지형 |
| `player` (2)      | `Player`              | **2** | **49** (`world`, `boss`, `boss_projectile`, `hazard`) | |
| `player_bullet` (3) | `Player_Bullet`       | **4** | **105** (`world`, `boss`, `hazard`, `boss_gimmick`) | |
| `boss` (4)        | `Boss`, `BrightSpot`  | **8** | **36** (`player_bullet`, `hazard`) | |
| `boss_projectile` (5)| `Boss_Bullet`         | **16**| **7** (`world`, `player`, `hazard`) | |
| `hazard` (6)      | `Stalactite`          | **32**| **15** (`world`, `player`, `boss`, `player_bullet`) | `Area2D` |
| `boss_gimmick` (7)  | `Torch`               | **64**| **4** (`player_bullet`) | |
| `interactable` (8) | (미사용)              | **128**| - | |

_참고: Layer 값은 비트마스크 값입니다. (예: 3번 레이어 -> 2^(3-1) = 4)_

-----------------------------------------------------
## 7. 향후 계획 (To-Do)
-----------------------------------------------------
*   **2스테이지 온도계 UI 생성:**
    *   세로 `ProgressBar` 형태의 온도계 UI를 생성합니다.
    *   냉동 게이지 값(0~100)에 따라 민트색 바가 아래에서 위로 채워지도록 구현합니다.
    *   현재 냉동 게이지를 숫자로 화면에 표시합니다. (초기 위치는 중앙)
*   보스 조준 시스템 추가 조정
*   보스 공격 패턴 추가 (예: 점프 패턴)
*   맵 디자인 확장
